name: Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 2.0.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (don\\'t actually publish)'
        required: false
        type: boolean
        default: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -e .
        
    - name: Run tests
      run: |
        pytest tests/ -v
        
    - name: Test package build
      run: |
        python -m build

  build-and-publish:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for version calculation
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel setuptools
        
    - name: Validate version
      run: |
        VERSION=${{ github.ref_name }}
        if [[ $VERSION == v* ]]; then
          VERSION=${VERSION#v}
        fi
        
        # Check if version matches __version__
        PACKAGE_VERSION=$(python -c "import fastgraph; print(fastgraph.__version__)")
        if [[ "$PACKAGE_VERSION" != "$VERSION" ]]; then
          echo "Package version ($PACKAGE_VERSION) does not match tag version ($VERSION)"
          exit 1
        fi
        
        echo "Version $VERSION validated"
        
    - name: Build packages
      run: |
        python -m build
        
    - name: Check packages
      run: |
        twine check dist/*
        
        # List built files
        ls -la dist/
        
        # Check package contents
        for file in dist/*; do
          echo "=== $file ==="
          if [[ $file == *.whl ]]; then
            python -m zipfile -l "$file" || true
          fi
        done
        
    - name: Test installation
      run: |
        # Test wheel installation
        python -m pip install dist/*.whl
        python -c "import fastgraph; print(fastgraph.__version__)"
        python -c "from fastgraph import FastGraph; g = FastGraph(); print('âœ“ Installation test passed')"
        
    - name: Publish to PyPI Test
      if: github.event.inputs.dry_run == 'false' || github.event.inputs.dry_run == '' || github.event.inputs.dry_run == null
      env:
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        TWINE_USERNAME: __token__
      run: |
        python -m twine upload --repository testpypi dist/*
        echo "âœ“ Published to Test PyPI"
        
    - name: Publish to PyPI
      if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
      env:
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        TWINE_USERNAME: __token__
      run: |
        python -m twine upload dist/*
        echo "âœ“ Published to PyPI"
        
  security-scan:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install security tools
      run: |
        pip install safety bandit
        
    - name: Run safety check
      run: |
        safety check --json || true
        
    - name: Run bandit security scan
      run: |
        bandit -r fastgraph/ -f json || true
        
  documentation:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install documentation dependencies
      run: |
        pip install sphinx sphinx-rtd-theme myst-parser
        
    - name: Build documentation
      run: |
        # Create basic documentation if docs/ directory exists
        if [ -d "docs" ]; then
          cd docs
          make html
        else
          echo "No docs directory found, skipping documentation build"
        fi || true
        
  post-publish:
    runs-on: ubuntu-latest
    needs: build-and-publish
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: FastGraph ${{ github.ref_name }}
        body: |
          ## FastGraph ${{ github.ref_name }}
          
          ### ðŸš€ Installation
          ```bash
          pip install fastgraph==${{ github.ref_name }}
          ```
          
          ### ðŸ“‹ What's Changed
          
          See [CHANGELOG.md](https://github.com/fastgraph/fastgraph/blob/main/CHANGELOG.md) for detailed changes.
          
          ### ðŸ”— Links
          - [PyPI](https://pypi.org/project/fastgraph/${{ github.ref_name }})
          - [Documentation](https://fastgraph.readthedocs.io)
          - [GitHub](https://github.com/fastgraph/fastgraph)
          
        draft: false
        prerelease: false
        
    - name: Notify deployment
      run: |
        echo "ðŸš€ FastGraph ${{ github.ref_name }} has been published!"
        echo "ðŸ“¦ Available on PyPI: pip install fastgraph==${{ github.ref_name }}"
        echo "ðŸ“š Documentation: https://fastgraph.readthedocs.io"